<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>SHUD</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="icon" href="/favicon.ico" type="image/png" />

    <style>
      .panel-cs2 {
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .button-cs2 {
        background: linear-gradient(90deg, #ffd600 0%, #ffea00 100%);
        color: #222;
        font-weight: bold;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.2s, background 0.2s;
      }
      .button-cs2:hover {
        box-shadow: 0 4px 16px #ffd60088;
        background: linear-gradient(90deg, #ffea00 0%, #ffd600 100%);
      }
      #maps-save-btn {
        display: none !important;
      }
      .file-name-note {
        margin-top: 6px;
        font-size: 12px;
        color: #ddd;
        word-break: break-all;
      }
    </style>

    <script>
      // Функция для исправления путей к аватаркам
      function fixAvatarPaths() {
        // Ищем все изображения с аватарками игроков
        const avatarImages = document.querySelectorAll(
          ".player-avatar img, .avatar-image"
        );

        avatarImages.forEach((img) => {
          if (
            img.src &&
            !img.src.includes("/uploads/") &&
            !img.src.includes("default-avatar.png")
          ) {
            // Получаем имя файла из пути
            const filename = img.src.split("/").pop();

            // Устанавливаем новый путь с префиксом /uploads/
            img.src = `/uploads/${filename}`;
            console.log("Fixed avatar path:", img.src);
          }
        });
      }

      // Запускаем функцию после загрузки страницы
      document.addEventListener("DOMContentLoaded", function () {
        // Запускаем сразу после загрузки DOM
        fixAvatarPaths();

        // Запускаем повторно через 1 секунду для динамически загруженного контента
        setTimeout(fixAvatarPaths, 1000);

        // Запускаем еще раз через 3 секунды для контента, загруженного с задержкой
        setTimeout(fixAvatarPaths, 3000);
      });
    </script>
  </head>
  <body>
    <div class="app-container">
      <!-- Боковое меню -->
      <nav class="sidebar">
        <div class="sidebar">
          <div class="logo">
            <img src="/images/logo.png" alt="SHUD Manager" />
          </div>
          <ul class="nav-menu">
            <li class="nav-item">
              <button class="nav-button" data-section="match-section">
                <i class="fas fa-gamepad"></i>
                <span data-i18n="navCreateMatch">Создать Матч</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button" data-section="teams-section">
                <i class="fas fa-users"></i>
                <span data-i18n="navCreateTeam">Создать Команду</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button" data-section="players-section">
                <i class="fas fa-user"></i>
                <span data-i18n="navCreatePlayer">Создать Игрока</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button" data-section="scoreboard-section">
                <i class="fas fa-table"></i>
                <span data-i18n="navScoreboard">Скорборд</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button" data-section="huds-section">
                <i class="fas fa-desktop"></i>
                <span data-i18n="navHuds">HUD'ы</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button" data-section="faceit-import-section">
                <i class="fas fa-cloud-download-alt"></i>
                <span data-i18n="navFaceitImport">FACEIT Импорт</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button active" data-section="cs2-section">
                <i class="fas fa-gamepad"></i>
                <span data-i18n="navCS2Integration">CFG Интеграция</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button active" data-section="cameras-section">
                <i class="fas fa-camera"></i>
                <span data-i18n="navCS2Cameras">Камеры BETA</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-button" data-section="hide-players-section">
                <i class="fas fa-user-slash"></i>
                <span data-i18n="navCS2Couching">Скрытие Тренера</span>
              </button>
            </li>
          </ul>
        </div>
        <div class="language-selector-container">
          <div>
            <label for="language-selector" data-i18n="languageSelector"
              >language:</label
            >
          </div>
          <select id="language-selector" class="form-control">
            <option value="ru">Русский</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <div class="social-links-container">
          <a
            href="https://discord.gg/7BtSdAmTf8"
            target="_blank"
            class="social-link discord"
            title="Discord"
          >
            <i class="fab fa-discord"></i>
          </a>
          <a
            href="https://www.twitch.tv/fyflo"
            target="_blank"
            class="social-link twitch"
            title="Twitch"
          >
            <i class="fab fa-twitch"></i>
          </a>
          <a
            href="https://kick.com/fyflo"
            target="_blank"
            class="social-link kick"
            title="Kick"
          >
            <i class="fas fa-play"></i>
          </a>
          <a
            href="https://t.me/CS_fyflo_stream"
            target="_blank"
            class="social-link telegram"
            title="Telegram"
          >
            <i class="fab fa-telegram"></i>
          </a>
          <a
            href="https://donatepay.ru/p/fyflo"
            target="_blank"
            class="social-link donate"
            title="На чай"
          >
            <i class="fas fa-coffee"></i>
          </a>
        </div>
      </nav>

      <!-- Основной контент -->
      <main class="main-content">
        <!-- FACEIT Импорт -->
        <section id="faceit-import-section" class="content-section panel-cs2">
          <h3 data-i18n="faceitImport">FACEIT Импорт</h3>
          <div class="form-group">
            <label for="faceit-matchroom" data-i18n="faceitMatchroomLabel"
              >Matchroom URL или ID</label
            >
            <input
              type="text"
              id="faceit-matchroom"
              placeholder="https://www.faceit.com/en/cs2/room/1-xxxx-.... или 1-xxxx-..."
              style="width: 100%"
            />
          </div>
          <button
            id="faceit-import-btn"
            class="button-cs2"
            style="width: 100%; margin-top: 8px"
          >
            <span data-i18n="getFaceitMatchroom"
              >Получить данные с Matchroom</span
            >
          </button>

          <hr style="margin: 16px 0; opacity: 0.2" />
          <div class="form-group">
            <label for="faceit-team-url" data-i18n="faceitTeamUrl"
              >URL команды FACEIT</label
            >
            <input
              type="text"
              id="faceit-team-url"
              placeholder="https://www.faceit.com/ru/teams/<teamId>"
              style="width: 100%"
            />
          </div>
          <button
            id="faceit-team-roster-btn"
            class="button-cs2"
            style="width: 100%; margin-top: 8px"
          >
            <span data-i18n="getFaceitTeamRoster">Получить состав команды</span>
          </button>
          <div id="faceit-team-roster-results" style="margin-top: 8px"></div>

          <div id="faceit-import-results" style="margin-top: 12px"></div>
        </section>

        <!-- Форма для скрытия игроков по Steam64 ID -->
        <section id="hide-players-section" class="content-section panel-cs2">
          <h3 data-i18n="hidePlayersTitle">Скрыть Тренера по Steam64 ID</h3>
          <form id="hidePlayersForm">
            <div class="form-group">
              <label for="steamid1">Steam64 ID 1:</label>
              <input
                type="text"
                id="steamid1"
                name="steamid1"
                maxlength="20"
                style="width: 100%"
                placeholder="7656..."
              />
            </div>
            <div class="form-group">
              <label for="steamid2">Steam64 ID 2:</label>
              <input
                type="text"
                id="steamid2"
                name="steamid2"
                maxlength="20"
                style="width: 100%"
                placeholder="7656..."
              />
            </div>
          </form>
          <button
            id="sendHidePlayersToHUD"
            class="button-cs2"
            style="margin-top: 10px; width: 100%"
            data-i18n="sendHidePlayersToHUD"
          >
            Отправить скрытие Тренера в HUD
          </button>
          <div id="spec-binds-block" style="margin-top: 12px">
            <h4 data-i18n="specBindsTitle">
              Бинды для выбора игроков (установка бинда: exec
              observer_spec_binds | сброс биндов: exec default.cfg)
            </h4>
            <div style="display: flex; gap: 8px; margin-bottom: 8px">
              <button id="refresh-binds" class="button-cs2">
                <span data-i18n="refreshBinds"></span>
              </button>
              <button id="copy-binds" class="button-cs2">
                <span data-i18n="copyBinds"></span>
              </button>
            </div>
            <textarea
              id="binds-output"
              readonly
              rows="10"
              style="width: 100%; font-family: monospace"
            ></textarea>
            <div class="file-name-note">
              <span data-i18n="slots"></span>
            </div>
          </div>
        </section>

        <script>
          // При загрузке страницы подставляем сохранённые значения
          document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("steamid1").value =
              localStorage.getItem("hiddenSteamId1") || "";
            document.getElementById("steamid2").value =
              localStorage.getItem("hiddenSteamId2") || "";

            // Кнопка отправки скрытия игроков в HUD
            const sendBtn = document.getElementById("sendHidePlayersToHUD");
            if (sendBtn) {
              sendBtn.addEventListener("click", function () {
                const steamid1 = document
                  .getElementById("steamid1")
                  .value.trim();
                const steamid2 = document
                  .getElementById("steamid2")
                  .value.trim();

                // Сохраняем ID в localStorage
                localStorage.setItem("hiddenSteamId1", steamid1);
                localStorage.setItem("hiddenSteamId2", steamid2);

                if (
                  window.gsiManager &&
                  typeof window.gsiManager.sendToHUD === "function"
                ) {
                  window.gsiManager.sendToHUD({
                    type: "hide_players",
                    steamids: [steamid1, steamid2],
                  });
                  alert("Скрытие игроков отправлено в HUD!");
                } else {
                  alert("Ошибка: GSIManager не доступен!");
                }
              });
            }

            // ===== Блок генерации биндов для выбора игроков =====
            const bindsOutput = document.getElementById("binds-output");
            const refreshBindsBtn = document.getElementById("refresh-binds");
            const copyBindsBtn = document.getElementById("copy-binds");

            function mapSlotToKey(slot) {
              const n = Number(slot);
              if (!Number.isFinite(n)) return null;
              if (n >= 0 && n <= 8) return String(n + 1);
              if (n === 9) return "0";
              if (n === 10) return "-";
              if (n === 11) return "=";
              return null;
            }

            function escapeQuotes(s) {
              return String(s || "").replace(/"/g, '\\"');
            }

            function sortPlayers(players) {
              const orderTeam = (t) => (t === "CT" ? 0 : t === "T" ? 1 : 2);
              return players.slice().sort((a, b) => {
                const ta = orderTeam(a.team);
                const tb = orderTeam(b.team);
                if (ta !== tb) return ta - tb;
                const sa = a.observer_slot ?? 999;
                const sb = b.observer_slot ?? 999;
                return sa - sb;
              });
            }

            async function fetchPlayers() {
              try {
                const resp = await fetch("/api/cs2/players");
                if (!resp.ok) throw new Error("HTTP " + resp.status);
                const data = await resp.json();
                return Array.isArray(data?.players) ? data.players : [];
              } catch (e) {
                console.error("Failed to fetch players:", e);
                return [];
              }
            }

            async function renderSpecBinds() {
              if (!bindsOutput) return;
              bindsOutput.value = "Обновление списка игроков...";

              const players = await fetchPlayers();
              const s1 = (
                document.getElementById("steamid1").value || ""
              ).trim();
              const s2 = (
                document.getElementById("steamid2").value || ""
              ).trim();
              const excluded = new Set([s1, s2].filter(Boolean));

              const filtered = players.filter(
                (p) => !excluded.has(String(p.steamid || ""))
              );
              const sorted = sortPlayers(filtered);

              const binds = [];
              for (const p of sorted) {
                const key = mapSlotToKey(p.observer_slot);
                if (!key) continue;
                const nick = p.name_ingame || p.name || "";
                if (!nick) continue;
                binds.push(
                  `bind "${key}" "spec_player \"${escapeQuotes(nick)}\""`
                );
              }

              const header = [
                "// Бинды для выбора игроков (генерация SHUD)",
                'echo "Paste / exec these binds in console"',
              ];
              const content = [...header, ...binds].join("\n");
              bindsOutput.value = content;
            }

            if (refreshBindsBtn) {
              refreshBindsBtn.addEventListener("click", () => {
                renderSpecBinds();
              });
            }

            if (copyBindsBtn && bindsOutput) {
              copyBindsBtn.addEventListener("click", async () => {
                try {
                  await navigator.clipboard.writeText(bindsOutput.value);
                } catch (_) {
                  bindsOutput.select();
                  document.execCommand("copy");
                }
              });
            }

            const steamid1Input = document.getElementById("steamid1");
            const steamid2Input = document.getElementById("steamid2");
            if (steamid1Input)
              steamid1Input.addEventListener("change", renderSpecBinds);
            if (steamid2Input)
              steamid2Input.addEventListener("change", renderSpecBinds);

            // Инициализируем показ биндов при загрузке
            renderSpecBinds();
          });
        </script>
        <!-- Конец формы -->
        <!-- Секция матча -->
        <section id="match-section" class="content-section active">
          <h2 data-i18n="matchSection">Создать Матч</h2>
          <div class="match-creator">
            <form id="createMatchForm">
              <div class="form-group">
                <label for="team1Select" data-i18n="team1">Команда 1</label>
                <select id="team1Select" required>
                  <option value="" data-i18n="selectTeam">
                    Выберите команду 1
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label for="team2Select" data-i18n="team2">Команда 2</label>
                <select id="team2Select" required>
                  <option value="" data-i18n="selectTeam">
                    Выберите команду 2
                  </option>
                </select>
              </div>

              <button type="submit" class="save-btn" data-i18n="createMatch">
                Создать матч
              </button>
            </form>
          </div>
          <!-- Добавляем список матчей -->
          <div class="matches-list">
            <h3 data-i18n="currentMatches">Текущие матчи</h3>

            <div class="matches-container" id="matches-list">
              <!-- Матчи будут добавляться динамически через JavaScript -->
            </div>
          </div>
          <div id="editMatchModal" class="modal">
            <div class="modal-content">
              <span data-i18n="editMatch">Редактор матча</span>
              <form id="editMatchForm">
                <div class="team-container-edit">
                  <div class="form-group">
                    <label id="editTeam1Label" for="editTeam1" data-i18n="team1"
                      >Команда 1:</label
                    >
                    <select name="team1" id="editTeam1" required>
                      <option value="" data-i18n="selectTeam">
                        Выберите команду
                      </option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label id="editTeam2Label" for="editTeam2" data-i18n="team2"
                      >Команда 2:</label
                    >
                    <select name="team2" id="editTeam2" required>
                      <option value="" data-i18n="selectTeam">
                        Выберите команду
                      </option>
                    </select>
                  </div>
                  <button type="button" id="editSwapTeamsBtn">
                    <i class="fas fa-exchange-alt"></i>
                  </button>
                </div>
                <div class="team-container-edit2">
                  <div class="form-group">
                    <label
                      id="editFormatLabel"
                      for="editFormat"
                      data-i18n="format"
                      >Формат:</label
                    >
                    <select name="format" id="editFormat" required>
                      <option value="bo1">BO1</option>
                      <option value="bo2">BO2</option>
                      <option value="bo3">BO3</option>
                      <option value="bo5">BO5</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="editMatchTime" data-i18n="matchTime"
                      >Время матча</label
                    >
                    <input
                      type="text"
                      id="editMatchTime"
                      name="matchTime"
                      placeholder="Например, 18:00 или 2024-08-05 18:00"
                      data-i18n="matchTimePlaceholder"
                    />
                  </div>
                </div>
                <div id="maps-save-btn" class="maps-save-btn">
                  <button data-i18n="save" type="submit">Сохранить</button>
                </div>
              </form>
            </div>
          </div>
        </section>
        <!-- Секция команд -->
        <!-- В секции teams-section -->

        <div id="teams-section" class="content-section">
          <h2 data-i18n="teamManagement">Управление командами</h2>
          <div class="form-container">
            <form id="team-form" enctype="multipart/form-data">
              <input
                data-i18n="teamName"
                type="text"
                name="name"
                placeholder="Название команды"
                required
              />
              <input
                data-i18n="teamShortName"
                type="text"
                name="short_name"
                placeholder="Короткое название команды"
                data-i18n="teamShortNamePlaceholder"
                maxlength="10"
              />
              <!-- Удалены регион и флаг из-за проблем совместимости в некоторых браузерах -->
              <div class="file-input-container" id="logo-input-container">
                <input
                  id="team-logo"
                  type="file"
                  name="logo"
                  accept="image/*"
                />
                <label
                  id="team-logo-label"
                  for="team-logo"
                  data-i18n="uploadTeamLogo"
                  >Загрузить логотип</label
                >
                <div id="team-logo-filename" class="file-name-note"></div>
              </div>
              <button data-i18n="addTeam" type="submit" id="add-team-btn">
                Добавить команду
              </button>
            </form>
          </div>
          <div class="section-header"></div>
          <div class="teams-container" id="teams-list">
            <!-- Команды будут добавлены динамически -->
          </div>
        </div>
        <!-- Секция игроков -->
        <section id="players-section" class="content-section">
          <h2 data-i18n="playerManagement">Управление игроками</h2>
          <form id="player-form">
            <input
              data-i18n="playerNickname"
              type="text"
              name="nickname"
              placeholder="Никнейм"
              required
            />
            <input
              data-i18n="playerRealName"
              type="text"
              name="realName"
              placeholder="Реальное имя"
            />
            <input
              data-i18n="playerSteam64"
              type="text"
              name="steam64"
              placeholder="Steam64 ID"
              required
            />
            <select name="teamId">
              <option value="" data-i18n="selectTeam">Выберите команду</option>
            </select>
            <div class="file-input-container" id="avatar-input-container">
              <input
                id="player-avatar"
                type="file"
                name="avatar"
                accept="image/*"
              />
              <label
                id="player-avatar-label"
                for="player-avatar"
                data-i18n="selectPlayerAvatar"
                >Загрузить аватар</label
              >
              <div id="player-avatar-filename" class="file-name-note"></div>
            </div>
            <button data-i18n="addPlayer" type="submit" id="add-player-btn">
              Добавить игрока
            </button>
          </form>

          <div id="players-list" class="players-container"></div>
        </section>

        <!-- В index.html, секция скорборда -->
        <section id="scoreboard-section" class="content-section">
          <h2 data-i18n="scoreboardSection">Скорборд</h2>
          <div class="scoreboard">
            <div class="team-scores"></div>
            <div class="player-stats-table">
              <!-- Таблица будет заполняться динамически -->
            </div>
          </div>
        </section>

        <!-- Секция HUD'ов -->
        <section id="huds-section" class="content-section">
          <h2 data-i18n="hudsSection">Доступные HUD'ы</h2>
          <div id="huds-list" class="huds-grid"></div>
          <!-- Модал настройки цветов HUD -->
          <div id="hud-colors-modal" class="modal" style="display: none">
            <div class="modal-content" style="max-width: 1200px; width: 95%">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                "
              >
                <h3 style="margin: 0">
                  Colors HUD: <span id="hud-colors-title"></span>
                </h3>
                <button id="hud-colors-close" class="btn btn-secondary">
                  ×
                </button>
              </div>
              <div
                id="hud-colors-form"
                style="
                  margin-top: 12px;
                  max-height: 60vh;
                  overflow-y: auto;
                  overflow-x: hidden;
                  padding-right: 8px;
                "
              ></div>
              <div style="display: flex; gap: 8px; margin-top: 12px">
                <button
                  data-i18n="save"
                  id="hud-colors-save"
                  class="btn btn-primary"
                ></button>
                <button
                  data-i18n="reset"
                  id="hud-colors-reset"
                  class="btn btn-warning"
                ></button>
                <button
                  data-i18n="cancel"
                  id="hud-colors-cancel"
                  class="btn btn-secondary"
                ></button>
              </div>
            </div>
          </div>
        </section>
        <section id="cs2-section" class="content-section">
          <div class="container mt-5">
            <div class="row">
              <div class="col-md-12">
                <div class="card-cfg">
                  <div class="card-header bg-primary text-white">
                    <h5
                      id="cs2-integration-title"
                      class="mb-0"
                      data-i18n="cs2Integration"
                    >
                      CFG Интеграция
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="cfg-block" id="block-cs2">
                      <h5 class="mb-2" data-i18n="cs2Integration">
                        Интеграция CS2
                      </h5>
                      <div class="row mb-4">
                        <div class="col-md-12">
                          <h6
                            id="cs2-configs-status"
                            data-i18n="cs2ConfigsStatus"
                          >
                            <span data-i18n="cs2ConfigsStatus"></span>
                          </h6>
                          <div class="status-list mb-2">
                            <p
                              id="cs2-gsi-status"
                              class="text-success mb-1"
                              data-i18n="cs2GsiInstalled"
                            >
                              <span class="status-dot green"></span
                              ><span data-i18n="cs2GsiInstalled"></span>
                              <span data-i18n="cs2GsiInstalled"></span>
                            </p>
                            <p
                              id="cs2-observer-status"
                              class="text-success mb-1"
                              data-i18n="cs2ObserverInstalled"
                            >
                              <span class="status-dot green"></span
                              ><span data-i18n="cs2ObserverInstalled"></span>
                            </p>
                            <p
                              id="cs2-observer_tools-status"
                              class="text-success mb-1"
                            >
                              <span class="status-dot green"></span
                              ><span
                                data-i18n="cs2ObserverToolsInstalled"
                              ></span>
                            </p>
                            <p
                              id="cs2-observer2-status"
                              class="text-danger mb-1"
                              data-i18n="cs2Observer2NotInstalled"
                            >
                              <span class="status-dot red"></span
                              ><span
                                data-i18n="cs2Observer2NotInstalled"
                              ></span>
                            </p>
                            <p
                              id="cs2-observer_off-status"
                              class="text-success mb-1"
                              data-i18n="cs2Observer_offInstalled"
                            >
                              <span class="status-dot green"></span>Observer_off
                              ><span
                                data-i18n="cs2Observer_offInstalled"
                              ></span>
                            </p>
                            <p
                              id="cs2-observer_hlae_kill-status"
                              class="text-success mb-1"
                            >
                              <span class="status-dot green"></span>
                              ><span
                                data-i18n="cs2ObserverHlaeKillInstalled"
                              ></span>
                            </p>
                            <p
                              id="cs2-shud_color-status"
                              class="text-success mb-1"
                            >
                              <span class="status-dot green"></span>SHUD color
                              cfg
                            </p>
                          </div>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-12">
                          <input
                            type="text"
                            id="cs2-custom-path"
                            class="form-control"
                            data-i18n="cs2CustomPath"
                            placeholder="Путь к CS2 (без game/csgo/cfg)"
                          />
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <div class="button-row">
                            <button
                              id="check-cs2-path"
                              class="btn btn-secondary"
                              data-i18n="cs2CheckPath"
                            >
                              <span data-i18n="cs2CheckPath"></span>
                            </button>
                            <button
                              id="install-cs2-configs"
                              class="btn btn-primary"
                              data-i18n="cs2InstallConfigs"
                            >
                              <span data-i18n="cs2InstallConfigs"></span>
                            </button>
                            <button
                              id="remove-cs2-configs"
                              class="btn btn-danger"
                              data-i18n="cs2RemoveConfigs"
                            >
                              <span data-i18n="cs2RemoveConfigs"></span>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="row mt-3">
                        <div class="col-md-12">
                          <button
                            id="launch-cs2-observer"
                            class="btn btn-success btn-block"
                            data-i18n="launch-cs2-observer"
                          >
                            <span data-i18n="cs2LaunchObserver"></span>
                          </button>
                          <button
                            id="launch-hlae"
                            class="btn btn-warning btn-block mt-2"
                            data-i18n="launch-hlae"
                          >
                            <span data-i18n="cs2LaunchHlae"></span>
                          </button>
                          <!-- Кнопка скрыта -->
                          <button
                            id="launch-cs2-hlae-insecure"
                            class="btn btn-info btn-block mt-2"
                            data-i18n="launch-cs2-hlae-insecure"
                          >
                            <span data-i18n="cs2LaunchHlaeInsecure"></span>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Dota 2 CFG Интеграция -->
                    <div class="cfg-block mt-4" id="block-dota2">
                      <h5 class="mb-2" data-i18n="dota2Integration">
                        Интеграция Dota 2
                      </h5>
                      <div class="row">
                        <div class="col-md-12">
                          <h6 data-i18n="dota2ConfigsStatus">
                            <span data-i18n="dota2ConfigsStatus"></span>
                          </h6>

                          <div id="dota2-cfg-details" style="display: none">
                            <p id="dota2-cfg-file-status">
                              ? <span data-i18n="dota2GsiStatus"></span>
                            </p>
                          </div>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-12">
                          <input
                            type="text"
                            id="dota2-custom-path"
                            class="form-control"
                            data-i18n="dota2CustomPath"
                            placeholder="Путь к Dota 2 (без game/dota/cfg)"
                          />
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <div class="button-row mb-2" role="group">
                            <button
                              id="check-dota2-cfg"
                              class="btn btn-info"
                              data-i18n="dota2CheckPath"
                            >
                              <span data-i18n="dota2CheckPath"></span>
                            </button>
                            <button
                              id="install-dota2-cfg"
                              class="btn btn-success"
                              data-i18n="dota2InstallConfigs"
                            >
                              <span data-i18n="dota2InstallConfigs"></span>
                            </button>
                            <button
                              id="remove-dota2-cfg"
                              class="btn btn-danger"
                              data-i18n="dota2RemoveConfigs"
                            >
                              <span data-i18n="dota2RemoveConfigs"></span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Редактор cfg -->
                    <div class="cfg-block mt-4" id="block-cfg-editor">
                      <h5 class="mb-2" data-i18n="cfgEditor">
                        Работа с cfg файлами
                      </h5>
                      <div class="col-md-12">
                        <div class="form-group mb-2">
                          <label for="cfg-file-select" data-i18n="cfgFile"
                            >Файл:</label
                          >
                          <select
                            id="cfg-file-select"
                            class="form-control"
                          ></select>
                        </div>
                        <div class="form-group mb-2">
                          <label for="cfg-editor" data-i18n="cfgContent"
                            >Содержимое:</label
                          >
                          <textarea
                            id="cfg-editor"
                            class="form-control"
                            rows="12"
                            style="font-family: monospace"
                          ></textarea>
                        </div>
                        <div class="btn-group" role="group">
                          <button
                            id="cfg-load"
                            class="btn btn-secondary"
                            data-i18n="cfgLoad"
                          >
                            <span data-i18n="cfgLoad"></span>
                          </button>
                          <button
                            id="cfg-save"
                            class="btn btn-primary"
                            data-i18n="cfgSave"
                          >
                            <span data-i18n="cfgSave"></span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- Секция Камеры -->
        <section id="cameras-section" class="content-section">
          <h2 data-i18n="cameraSelector">Селектор камеры</h2>
          <div id="camera-players-list">
            <h3 data-i18n="teamCT">Команда CT</h3>
            <div class="camera-team-list">
              <div class="camera-player-row">
                <span class="camera-player-name" data-i18n="MisTraLook"
                  >MisTraLook</span
                >
                <input ... />
                <button ... data-i18n="save">
                  <span data-i18n="save"></span>Сохранить
                </button>
              </div>
              <!-- ... -->
            </div>
            <h3 data-i18n="teamT">Команда T</h3>
            <div class="camera-team-list">
              <div class="camera-player-row">
                <span class="camera-player-name" data-i18n="dS">dS</span>
                <input ... />
                <button ... data-i18n="save">
                  <span data-i18n="save"></span> Сохранить
                </button>
              </div>
              <!-- ... -->
            </div>
          </div>
          <button id="refresh-cameras-btn" data-i18n="refreshCameras">
            <span data-i18n="refreshCameras"></span> Обновить список игроков
          </button>
        </section>
      </main>
    </div>

    <script>
      // Скрипт для обработки выбора файла логотипа и аватарки
      document.addEventListener("DOMContentLoaded", function () {
        function initFileInputs() {
          // Инициализация для логотипа команды
          initFileInput(
            "team-logo",
            "logo-input-container",
            "team-logo-label",
            "Загрузить логотип",
            "team-logo-filename"
          );

          // Инициализация для аватарки игрока
          initFileInput(
            "player-avatar",
            "avatar-input-container",
            "player-avatar-label",
            "Загрузить аватар",
            "player-avatar-filename"
          );
        }

        function initFileInput(
          inputId,
          containerId,
          labelId,
          defaultText,
          fileNameDisplayId
        ) {
          const input = document.getElementById(inputId);
          const container = document.getElementById(containerId);
          const label = document.getElementById(labelId);
          const fileNameDisplay = fileNameDisplayId
            ? document.getElementById(fileNameDisplayId)
            : null;

          if (input && container && label) {
            input.addEventListener("change", function () {
              if (this.files && this.files.length > 0) {
                const fileName = this.files[0].name;
                if (fileNameDisplay) fileNameDisplay.textContent = fileName;
                label.textContent = defaultText;
                container.classList.add("has-file");
                label.style.backgroundColor = "#007bff";
                label.style.color = "white";
              } else {
                label.textContent = defaultText;
                container.classList.remove("has-file");
                label.style.backgroundColor = "";
                label.style.color = "";
                if (fileNameDisplay) fileNameDisplay.textContent = "";
              }
            });
          }
        }

        // Функция для сброса формы файла
        function resetFileInput(
          inputId,
          containerId,
          labelId,
          defaultText,
          fileNameDisplayId
        ) {
          const input = document.getElementById(inputId);
          const container = document.getElementById(containerId);
          const label = document.getElementById(labelId);
          const fileNameDisplay = fileNameDisplayId
            ? document.getElementById(fileNameDisplayId)
            : null;

          if (input) {
            input.value = "";
          }
          if (container) {
            container.classList.remove("has-file");
          }
          if (label) {
            label.textContent = defaultText;
            label.style.backgroundColor = "";
            label.style.color = "";
          }
          if (fileNameDisplay) fileNameDisplay.textContent = "";
        }

        // Функция для изменения кнопки при редактировании
        function changeButtonToEdit(buttonId, newText) {
          const button = document.getElementById(buttonId);
          if (button) {
            button.textContent = newText;
            button.style.backgroundColor = "#007bff";
            button.style.borderColor = "#007bff";
          }
        }

        // Функция для возврата кнопки к исходному состоянию
        function resetButtonToAdd(buttonId, originalText) {
          const button = document.getElementById(buttonId);
          if (button) {
            button.textContent = originalText;
            button.style.backgroundColor = "";
            button.style.borderColor = "";
          }
        }

        // Инициализируем обработчики при загрузке страницы
        initFileInputs();

        // Обработчик успешного добавления команды
        const teamForm = document.getElementById("team-form");
        if (teamForm) {
          teamForm.addEventListener("submit", function (e) {
            // Сброс формы файла после успешного добавления
            setTimeout(() => {
              resetFileInput(
                "team-logo",
                "logo-input-container",
                "team-logo-label",
                "Загрузить логотип",
                "team-logo-filename"
              );
              resetButtonToAdd("add-team-btn", "Добавить команду");
            }, 1000);
          });
        }

        // Обработчик успешного добавления игрока
        const playerForm = document.getElementById("player-form");
        if (playerForm) {
          playerForm.addEventListener("submit", function (e) {
            // Сброс формы файла после успешного добавления
            setTimeout(() => {
              resetFileInput(
                "player-avatar",
                "avatar-input-container",
                "player-avatar-label",
                "Загрузить аватар",
                "player-avatar-filename"
              );
              resetButtonToAdd("add-player-btn", "Добавить игрока");
            }, 1000);
          });
        }

        // Инициализируем обработчики после переключения вкладок
        const navButtons = document.querySelectorAll(".nav-button");
        if (navButtons) {
          navButtons.forEach((button) => {
            button.addEventListener("click", function () {
              // Даем DOM время обновиться после переключения вкладки
              setTimeout(initFileInputs, 200);
            });
          });
        }

        // Глобальные функции для использования в main.js
        window.changeButtonToEdit = changeButtonToEdit;
        window.resetButtonToAdd = resetButtonToAdd;

        // Запуск CS2 через Steam protocol с +exec observer
        const launchBtn = document.getElementById("launch-cs2-observer");
        if (launchBtn) {
          launchBtn.addEventListener("click", async function () {
            try {
              const resp = await fetch("/api/launch-cs2-exec", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ configName: "observer" }),
              });
              const data = await resp.json().catch(() => ({}));
              if (resp.ok) {
                alert("CS2 запускается с exec observer");
              } else {
                alert(`Ошибка запуска: ${data.error || "неизвестно"}`);
              }
            } catch (e) {
              alert("Ошибка запроса к серверу запуска CS2");
            }
          });
        }

        // Запуск HLAE
        const launchHlaeBtn = document.getElementById("launch-hlae");
        if (launchHlaeBtn) {
          launchHlaeBtn.addEventListener("click", async function () {
            try {
              const resp = await fetch("/api/launch-hlae", { method: "POST" });
              const data = await resp.json().catch(() => ({}));
              if (resp.ok) {
                alert("HLAE запускается");
              } else {
                alert(`Ошибка запуска HLAE: ${data.error || "неизвестно"}`);
              }
            } catch (e) {
              alert("Ошибка запроса к серверу запуска HLAE");
            }
          });
        }

        // Запуск CS2 HLAE с -insecure
        const launchCs2HlaeInsecureBtn = document.getElementById(
          "launch-cs2-hlae-insecure"
        );
        if (launchCs2HlaeInsecureBtn) {
          launchCs2HlaeInsecureBtn.addEventListener("click", async function () {
            const customPathInput = document.getElementById("cs2-custom-path");
            const cs2Path =
              (customPathInput && customPathInput.value.trim()) || undefined;
            // Путь к interop (если есть локально)
            const interopPath =
              "H:/project/public/afx-cefhud-interop/afx-cefhud-interop.exe";
            try {
              const resp = await fetch("/api/launch-cs2-hlae-insecure", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cs2Path, interopPath }),
              });
              const data = await resp.json().catch(() => ({}));
              if (resp.ok) {
                alert("CS2 запускается через HLAE с -insecure");
              } else {
                alert(`Ошибка запуска: ${data.error || "неизвестно"}`);
              }
            } catch (e) {
              alert("Ошибка запроса запуска через HLAE");
            }
          });
        }

        // Редактор cfg
        const cfgSelect = document.getElementById("cfg-file-select");
        const cfgEditor = document.getElementById("cfg-editor");
        const cfgLoadBtn = document.getElementById("cfg-load");
        const cfgSaveBtn = document.getElementById("cfg-save");

        async function loadCfgList() {
          try {
            const resp = await fetch("/api/cs2-config/list");
            const data = await resp.json();
            if (resp.ok && data.success) {
              cfgSelect.innerHTML = "";
              for (const f of data.files) {
                const opt = document.createElement("option");
                opt.value = f;
                opt.textContent = f;
                cfgSelect.appendChild(opt);
              }
            } else {
              alert(`Ошибка списка файлов: ${data.error || "неизвестно"}`);
            }
          } catch (e) {
            alert("Ошибка запроса списка файлов");
          }
        }

        async function loadCfg() {
          const name = cfgSelect.value;
          const url = new URL("/api/cs2-config", window.location.origin);
          url.searchParams.set("name", name);
          try {
            const resp = await fetch(url.toString());
            const data = await resp.json();
            if (resp.ok && data.success) {
              cfgEditor.value = data.content || "";
            } else {
              alert(`Ошибка загрузки: ${data.error || "неизвестно"}`);
            }
          } catch (e) {
            alert("Ошибка запроса при загрузке файла");
          }
        }

        async function saveCfg() {
          const name = cfgSelect.value;
          const body = { name, content: cfgEditor.value };
          try {
            const resp = await fetch("/api/cs2-config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && data.success) {
              alert("Файл сохранён");
            } else {
              alert(`Ошибка сохранения: ${data.error || "неизвестно"}`);
            }
          } catch (e) {
            alert("Ошибка запроса при сохранении файла");
          }
        }

        if (cfgLoadBtn) cfgLoadBtn.addEventListener("click", loadCfg);
        if (cfgSaveBtn) cfgSaveBtn.addEventListener("click", saveCfg);
        if (cfgSelect) cfgSelect.addEventListener("change", loadCfg);
        // Инициализация: подтянуть список и после загрузить первый файл
        loadCfgList().then(() => {
          if (cfgSelect && cfgSelect.options.length > 0) {
            loadCfg();
          }
        });

        // Dota 2 CFG Integration
        const checkDota2CfgBtn = document.getElementById("check-dota2-cfg");
        const installDota2CfgBtn = document.getElementById("install-dota2-cfg");
        // Убрали общую строку статуса, используем только детальную лампочку
        const dota2CfgInfo = document.getElementById("dota2-cfg-info");
        const dota2Path = document.getElementById("dota2-path");
        const dota2CfgPath = document.getElementById("dota2-cfg-path");

        async function checkDota2CfgInstallation() {
          try {
            const customDotaPathInput =
              document.getElementById("dota2-custom-path");
            let url = "/api/dota2-cfg-check";
            if (customDotaPathInput && customDotaPathInput.value) {
              url += `?path=${encodeURIComponent(customDotaPathInput.value)}`;
            }
            const response = await fetch(url);
            const data = await response.json();

            // Общую строку статуса не показываем; ниже выставляем лампочку в деталях

            // Показываем детальный статус
            const detailsDiv = document.getElementById("dota2-cfg-details");
            const fileStatus = document.getElementById("dota2-cfg-file-status");

            if (detailsDiv) {
              detailsDiv.style.display = "block";

              if (fileStatus) {
                if (data.cfgExists) {
                  fileStatus.innerHTML =
                    '<span class="status-dot green"></span><span data-i18n="dota2GsiInstalled"></span>';
                } else {
                  fileStatus.innerHTML =
                    '<span class="status-dot red"></span><span data-i18n="dota2GsiNotInstalled"></span>';
                }
              }
            }

            // Информация о путях скрыта по ТЗ; ничего не показываем
          } catch (error) {
            console.error("Error checking Dota 2 CFG:", error);
            const detailsDiv = document.getElementById("dota2-cfg-details");
            const fileStatus = document.getElementById("dota2-cfg-file-status");
            if (detailsDiv) detailsDiv.style.display = "block";
            if (fileStatus)
              fileStatus.innerHTML =
                '<span class="status-dot red"></span><span data-i18n="dota2GsiNotInstalled"></span>';
          }
        }

        async function installDota2Cfg() {
          try {
            const customDotaPathInput =
              document.getElementById("dota2-custom-path");
            const response = await fetch("/api/dota2-cfg-install", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ path: customDotaPathInput?.value || "" }),
            });
            await response.json();
          } catch (error) {
            console.error("Error installing Dota 2 CFG:", error);
          } finally {
            setTimeout(() => {
              checkDota2CfgInstallation();
            }, 500);
          }
        }

        async function removeDota2Cfg() {
          if (!confirm("Вы уверены, что хотите удалить CFG файл Dota 2?")) {
            return;
          }

          try {
            const customDotaPathInput =
              document.getElementById("dota2-custom-path");
            let url = "/api/dota2-cfg-remove";
            if (customDotaPathInput && customDotaPathInput.value) {
              url += `?path=${encodeURIComponent(customDotaPathInput.value)}`;
            }
            await (await fetch(url)).json();
          } catch (error) {
            console.error("Error removing Dota 2 CFG:", error);
          } finally {
            setTimeout(() => {
              checkDota2CfgInstallation();
            }, 500);
          }
        }

        // Добавляем обработчики событий
        if (checkDota2CfgBtn) {
          checkDota2CfgBtn.addEventListener("click", async function () {
            try {
              await checkDota2CfgInstallation();
            } finally {
            }
          });
        }
        if (installDota2CfgBtn) {
          installDota2CfgBtn.addEventListener("click", installDota2Cfg);
        }

        const removeDota2CfgBtn = document.getElementById("remove-dota2-cfg");
        if (removeDota2CfgBtn) {
          removeDota2CfgBtn.addEventListener("click", removeDota2Cfg);
        }

        // Автоматическая проверка при загрузке страницы
        checkDota2CfgInstallation();
      });
    </script>

    <!-- Font Awesome для иконок -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- Скрипты -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/js/gsiManager.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/overlayManager.js"></script>
    <script src="/js/localization.js"></script>

    <script src="/js/version-check.js"></script>
  </body>
</html>
